<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Cookies Cross-Origin</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #4CAF50;
        }

        h2 {
            color: #2196F3;
            margin-top: 30px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .result {
            background: #333;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            border-left-color: #f44336;
            color: #ff6b6b;
        }

        .success {
            border-left-color: #4CAF50;
            color: #69f0ae;
        }

        .warning {
            border-left-color: #ff9800;
            color: #ffd54f;
        }

        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 5px;
            font-size: 14px;
        }

        label {
            display: block;
            margin-top: 15px;
            color: #aaa;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üç™ Test de Cookies Cross-Origin</h1>
        <p>Este test verifica si las cookies se env√≠an correctamente en peticiones cross-origin.</p>

        <h2>‚öôÔ∏è Configuraci√≥n</h2>
        <label>URL del API (backend):</label>
        <input type="text" id="apiUrl" value="https://casino-platform-production.up.railway.app/api/v1" />

        <label>Endpoint de login:</label>
        <input type="text" id="loginEndpoint" value="/auth/login" />

        <label>Endpoint de verificaci√≥n:</label>
        <input type="text" id="meEndpoint" value="/auth/me" />

        <h2>üß™ Tests</h2>
        <button onclick="testCookieStorage()">1. Verificar Cookies Almacenadas</button>
        <button onclick="testCORS()">2. Test CORS Preflight</button>
        <button onclick="testLogin()">3. Test Login (simular)</button>
        <button onclick="testMeEndpoint()">4. Test /me (verificar env√≠o de cookie)</button>
        <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>

        <div id="results"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
            console.log(message);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        function getApiUrl() {
            return document.getElementById('apiUrl').value;
        }

        function testCookieStorage() {
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'result');
            log('üç™ TEST 1: Verificar Cookies Almacenadas', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'result');

            const cookies = document.cookie;

            if (!cookies) {
                log('‚ö†Ô∏è NO HAY COOKIES visibles desde JavaScript', 'warning');
                log('Esto es NORMAL si las cookies son HttpOnly.', 'result');
                log('\nüìã INSTRUCCIONES:', 'result');
                log('1. Abre DevTools (F12)', 'result');
                log('2. Ve a: Application ‚Üí Cookies ‚Üí ' + window.location.hostname, 'result');
                log('3. Verifica si existe una cookie llamada "jwt" o "auth_token"', 'result');
                log('\n‚úÖ Si ves la cookie: El problema es que NO SE ENV√çA', 'success');
                log('‚ùå Si NO ves la cookie: El problema es que NO SE GUARD√ì', 'error');
            } else {
                log('‚úÖ Cookies visibles:', 'success');
                log(cookies, 'result');
            }
        }

        async function testCORS() {
            log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'result');
            log('üåê TEST 2: CORS Preflight', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'result');

            const apiUrl = getApiUrl();
            const meEndpoint = document.getElementById('meEndpoint').value;
            const url = apiUrl + meEndpoint;

            try {
                log('üîó URL: ' + url, 'result');
                log('üì§ Enviando OPTIONS request...\n', 'result');

                const response = await fetch(url, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'GET',
                        'Access-Control-Request-Headers': 'content-type'
                    }
                });

                log('Status: ' + response.status, response.ok ? 'success' : 'error');

                const allowOrigin = response.headers.get('Access-Control-Allow-Origin');
                const allowCredentials = response.headers.get('Access-Control-Allow-Credentials');
                const allowMethods = response.headers.get('Access-Control-Allow-Methods');
                const allowHeaders = response.headers.get('Access-Control-Allow-Headers');

                log('\nüìã Response Headers:', 'result');
                log('Access-Control-Allow-Origin: ' + (allowOrigin || '‚ùå NO PRESENTE'), allowOrigin ? 'success' : 'error');
                log('Access-Control-Allow-Credentials: ' + (allowCredentials || '‚ùå NO PRESENTE'), allowCredentials === 'true' ? 'success' : 'error');
                log('Access-Control-Allow-Methods: ' + (allowMethods || '‚ùå NO PRESENTE'), 'result');
                log('Access-Control-Allow-Headers: ' + (allowHeaders || '‚ùå NO PRESENTE'), 'result');

                if (!allowCredentials || allowCredentials !== 'true') {
                    log('\n‚ùå PROBLEMA DETECTADO:', 'error');
                    log('El backend NO est√° permitiendo credenciales (cookies).', 'error');
                    log('Soluci√≥n: Agregar .AllowCredentials() en la configuraci√≥n de CORS del backend.', 'warning');
                }

                if (!allowOrigin || (allowOrigin !== '*' && allowOrigin !== window.location.origin)) {
                    log('\n‚ùå PROBLEMA DETECTADO:', 'error');
                    log('El origen actual NO est√° permitido en CORS.', 'error');
                    log('Origen actual: ' + window.location.origin, 'result');
                    log('Origen permitido: ' + allowOrigin, 'result');
                    log('Soluci√≥n: Agregar "' + window.location.origin + '" a ALLOWED_ORIGINS en el backend.', 'warning');
                }

            } catch (error) {
                log('‚ùå Error en OPTIONS request:', 'error');
                log(error.message, 'error');
            }
        }

        async function testLogin() {
            log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'result');
            log('üîê TEST 3: Login (Simulaci√≥n)', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'result');

            const apiUrl = getApiUrl();
            const loginEndpoint = document.getElementById('loginEndpoint').value;
            const url = apiUrl + loginEndpoint;

            log('‚ö†Ô∏è Este test requiere credenciales v√°lidas.', 'warning');
            log('Por ahora, solo verifica la configuraci√≥n de CORS.\n', 'warning');

            log('üìã INSTRUCCIONES PARA VERIFICAR MANUALMENTE:', 'result');
            log('1. Haz login en tu aplicaci√≥n', 'result');
            log('2. Abre DevTools ‚Üí Network', 'result');
            log('3. Busca la petici√≥n POST ' + loginEndpoint, 'result');
            log('4. En la pesta√±a "Headers" ‚Üí "Response Headers", verifica:', 'result');
            log('   - Set-Cookie: jwt=...; Path=/; HttpOnly; Secure; SameSite=None', 'result');
            log('   - Access-Control-Allow-Credentials: true', 'result');
            log('   - Access-Control-Allow-Origin: ' + window.location.origin, 'result');
            log('\n‚úÖ Si ves estos headers: El backend est√° configurado correctamente', 'success');
            log('‚ùå Si NO ves Set-Cookie: El backend NO est√° enviando la cookie', 'error');
            log('‚ùå Si NO ves Allow-Credentials: true: El backend NO permite cookies cross-origin', 'error');
        }

        async function testMeEndpoint() {
            log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'result');
            log('üë§ TEST 4: /me Endpoint (Verificar env√≠o de cookie)', 'success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n', 'result');

            const apiUrl = getApiUrl();
            const meEndpoint = document.getElementById('meEndpoint').value;
            const url = apiUrl + meEndpoint;

            try {
                log('üîó URL: ' + url, 'result');
                log('üì§ Enviando GET request con credentials: "include"...\n', 'result');

                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include', // ‚Üê CR√çTICO: equivalente a withCredentials
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                log('Status: ' + response.status + ' ' + response.statusText, response.ok ? 'success' : 'error');

                const allowOrigin = response.headers.get('Access-Control-Allow-Origin');
                const allowCredentials = response.headers.get('Access-Control-Allow-Credentials');

                log('\nüìã Response Headers:', 'result');
                log('Access-Control-Allow-Origin: ' + (allowOrigin || '‚ùå NO PRESENTE'), allowOrigin ? 'success' : 'error');
                log('Access-Control-Allow-Credentials: ' + (allowCredentials || '‚ùå NO PRESENTE'), allowCredentials === 'true' ? 'success' : 'error');

                if (response.status === 401) {
                    log('\n‚ö†Ô∏è Status 401 Unauthorized - Posibles causas:', 'warning');
                    log('1. No hay sesi√≥n activa (no has hecho login)', 'result');
                    log('2. La cookie NO se est√° enviando en la request', 'result');
                    log('3. La cookie expir√≥', 'result');
                    log('\nüìã Para verificar si la cookie se envi√≥:', 'result');
                    log('1. Abre DevTools ‚Üí Network', 'result');
                    log('2. Busca la petici√≥n GET ' + meEndpoint, 'result');
                    log('3. En "Request Headers", verifica si existe "Cookie: jwt=..."', 'result');
                    log('\n‚úÖ Si ves el header Cookie: La cookie S√ç se envi√≥ (problema de backend)', 'success');
                    log('‚ùå Si NO ves el header Cookie: La cookie NO se envi√≥ (problema de frontend o backend CORS)', 'error');
                }

                if (response.ok) {
                    const data = await response.json();
                    log('\n‚úÖ Respuesta exitosa:', 'success');
                    log(JSON.stringify(data, null, 2), 'result');
                    log('\nüéâ La cookie se envi√≥ correctamente!', 'success');
                } else {
                    const text = await response.text();
                    log('\n‚ùå Respuesta de error:', 'error');
                    log(text, 'error');
                }

            } catch (error) {
                log('\n‚ùå Error en la petici√≥n:', 'error');
                log(error.message, 'error');

                if (error.message.includes('CORS')) {
                    log('\nüî• ERROR DE CORS DETECTADO', 'error');
                    log('Soluci√≥n:', 'warning');
                    log('1. Verifica que el backend tenga configurado CORS correctamente', 'result');
                    log('2. Agrega este origen a ALLOWED_ORIGINS: ' + window.location.origin, 'result');
                    log('3. Aseg√∫rate de que .AllowCredentials() est√© configurado', 'result');
                }
            }
        }

        // Auto-ejecutar test de cookies al cargar
        window.addEventListener('load', () => {
            log('üöÄ Test de Cookies Cross-Origin iniciado', 'success');
            log('Frontend URL: ' + window.location.origin, 'result');
            log('Backend URL: ' + getApiUrl() + '\n', 'result');
        });
    </script>
</body>

</html>